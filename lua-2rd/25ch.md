第 25 章 扩展应用程序
=====================

lua一项重要用途就是作为一种配置语言。

## 25\.1 基础

```lua
-- 定义窗口大小
width = 200
height = 300
```

获得全局变量width和height

```c
void load(lua_State *L, const char *fname, int *w, int *h)
{
	if (luaL_loadfile(L, fname) || lua_pcall(L, 0, 0, 0))
	{
		error(L, "cannot run config. file : %s", lua_tostring(L, -1));
	}

	lua_getglobal(L, "width");
	lua_getglobal(L, "height");

	if (!lua_isnumber(L, -2))
		error(L, "'width' should be a number");

	if (!lua_isnumber(L, -1))
		error(L, "'height' should be a number");

	*w = lua_tointeger(L, -2);
	*h = lua_tointeger(L, -1);
}
```

## 25\.2 table操作

```lua
-- config file
width = 200
height = 300
background_red = 0.30
background_green = 0.10
background_blue = 0
```

缺点：

* 太冗长
* 无法预定义常量颜色

使用table表示颜色

```lua
background = {r = 0.30, g = 0.10, b = 0}

BLUE = {r = 0, g = 0, b = 1.0}
background = BLUE
```

C语言获取table

```c
#define MAX_COLOR 255

int getfiled(lua_State *L, const char *key)
{
	int result;
	lua_pushstring(L, key);
	lua_gettable(L, -2);
	if (!lua_isnumber(L, -1))
		error(L, "invalid component in background color");
	result = (int)lua_tonumber(L, -1) * MAX_COLOR;
	lua_pop(L, 1);
	return result;
}

int main()
{

	lua_getglobal(L, "background");

	if (!lua_istable(L, -1))
		error(L, "'background' is not a table");

	red = getfiled(L, "r");
	green = getfiled(L, "g");
	blue = getfiled(L, "b");
	return 0;
}
```


